// Prisma schema for PYRAX Presale Admin Dashboard

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ Admin & Auth ============

model Admin {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  role          AdminRole @default(VIEWER)
  walletAddress String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLogin     DateTime?
  active        Boolean   @default(true)

  auditLogs AuditLog[]
  sessions  AdminSession[]
}

model AdminSession {
  id        String   @id @default(cuid())
  adminId   String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  ipAddress String?
  userAgent String?

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  VIEWER
}

// ============ Presale Phases ============

model PresalePhase {
  id            String   @id @default(cuid())
  phaseNumber   Int      @unique
  name          String
  description   String?
  priceUsd      Decimal  @db.Decimal(18, 6)
  pyrxBonusBps  Int      @default(0)
  xfBonusBps    Int      @default(0)
  capUsd        Decimal  @db.Decimal(18, 6)
  raisedUsd     Decimal  @default(0) @db.Decimal(18, 6)
  startTime     DateTime?
  endTime       DateTime?
  active        Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  contributions Contribution[]
}

// ============ Testnet Phases ============

model TestnetPhase {
  id          String   @id @default(cuid())
  phaseNumber Int      @unique
  name        String
  theme       String
  description String?
  objectives  String[]
  rewards     String?
  startTime   DateTime?
  endTime     DateTime?
  active      Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  participants TestnetParticipant[]
}

model TestnetParticipant {
  id            String   @id @default(cuid())
  phaseId       String
  walletAddress String
  email         String?
  tasksCompleted Int     @default(0)
  rewardsEarned Decimal @default(0) @db.Decimal(18, 6)
  joinedAt      DateTime @default(now())

  phase TestnetPhase @relation(fields: [phaseId], references: [id])

  @@unique([phaseId, walletAddress])
}

// ============ Contributions ============

model Contribution {
  id              String   @id @default(cuid())
  phaseId         String
  walletAddress   String
  email           String?
  
  // Amounts contributed
  ethAmount       Decimal  @default(0) @db.Decimal(18, 8)
  usdcAmount      Decimal  @default(0) @db.Decimal(18, 6)
  usdtAmount      Decimal  @default(0) @db.Decimal(18, 6)
  wbtcAmount      Decimal  @default(0) @db.Decimal(18, 8)
  totalUsd        Decimal  @db.Decimal(18, 6)
  
  // Tokens to receive
  pyrxAmount      Decimal  @db.Decimal(18, 0)
  xfAmount        Decimal  @db.Decimal(18, 0)
  
  // Transaction details
  txHash          String?
  blockNumber     Int?
  status          ContributionStatus @default(PENDING)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  claimedAt       DateTime?

  phase PresalePhase @relation(fields: [phaseId], references: [id])

  @@index([walletAddress])
  @@index([txHash])
}

enum ContributionStatus {
  PENDING
  CONFIRMED
  FAILED
  CLAIMED
  REFUNDED
}

// ============ Treasury ============

model Treasury {
  id            String   @id @default(cuid())
  name          String
  address       String   @unique
  chain         String
  type          TreasuryType
  description   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  balances TreasuryBalance[]
  transactions TreasuryTransaction[]
}

model TreasuryBalance {
  id          String   @id @default(cuid())
  treasuryId  String
  token       String
  balance     Decimal  @db.Decimal(28, 18)
  usdValue    Decimal? @db.Decimal(18, 2)
  updatedAt   DateTime @updatedAt

  treasury Treasury @relation(fields: [treasuryId], references: [id])

  @@unique([treasuryId, token])
}

model TreasuryTransaction {
  id          String   @id @default(cuid())
  treasuryId  String
  type        TransactionType
  token       String
  amount      Decimal  @db.Decimal(28, 18)
  from        String?
  to          String?
  txHash      String?
  description String?
  createdAt   DateTime @default(now())

  treasury Treasury @relation(fields: [treasuryId], references: [id])

  @@index([txHash])
}

enum TreasuryType {
  PRESALE
  FOUNDATION
  ECOSYSTEM
  TEAM
  LIQUIDITY
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  TRANSFER
  SWAP
}

// ============ Analytics ============

model DailyStats {
  id              String   @id @default(cuid())
  date            DateTime @unique @db.Date
  
  // Presale stats
  contributionsCount Int    @default(0)
  uniqueContributors Int    @default(0)
  totalRaisedUsd    Decimal @default(0) @db.Decimal(18, 6)
  pyrxSold          Decimal @default(0) @db.Decimal(18, 0)
  xfDistributed     Decimal @default(0) @db.Decimal(18, 0)
  
  // By payment method
  ethRaised         Decimal @default(0) @db.Decimal(18, 8)
  usdcRaised        Decimal @default(0) @db.Decimal(18, 6)
  usdtRaised        Decimal @default(0) @db.Decimal(18, 6)
  wbtcRaised        Decimal @default(0) @db.Decimal(18, 8)
  
  createdAt         DateTime @default(now())
}

// ============ Audit Logs ============

model AuditLog {
  id          String   @id @default(cuid())
  adminId     String?
  action      String
  entity      String
  entityId    String?
  details     Json?
  ipAddress   String?
  createdAt   DateTime @default(now())

  admin Admin? @relation(fields: [adminId], references: [id])

  @@index([adminId])
  @@index([entity, entityId])
}

// ============ Settings ============

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  type      String   @default("string")
  updatedAt DateTime @updatedAt
}

// ============ CRUCIBLE & FOUNDRY - AI/ML Platform ============

// User account (wallet-based authentication)
model User {
  id            String    @id @default(cuid())
  walletAddress String    @unique
  email         String?
  name          String?
  credits       Decimal   @default(0) @db.Decimal(18, 6)
  tier          UserTier  @default(FREE)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastActiveAt  DateTime?

  apiKeys       ApiKey[]
  jobs          Job[]
  datasets      Dataset[]
  trainedModels TrainedModel[]
  payments      Payment[]

  @@index([walletAddress])
}

enum UserTier {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

// API Keys for programmatic access
model ApiKey {
  id          String    @id @default(cuid())
  userId      String
  name        String
  keyHash     String    @unique // Store hashed key, not plaintext
  keyPrefix   String    // First 8 chars for identification (pyrax_xxx...)
  permissions String[]  @default(["crucible:read", "crucible:write", "foundry:read", "foundry:write"])
  rateLimit   Int       @default(100) // requests per minute
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([keyHash])
  @@index([userId])
}

// Jobs - Crucible inference and Foundry training
model Job {
  id            String    @id @default(cuid())
  userId        String
  type          JobType
  status        JobStatus @default(PENDING)
  priority      Int       @default(0)
  
  // Model and input
  model         String
  input         Json      // Prompt, config, parameters
  output        Json?     // Results, generated content
  
  // Cost tracking
  estimatedCost Decimal   @default(0) @db.Decimal(18, 6)
  actualCost    Decimal   @default(0) @db.Decimal(18, 6)
  
  // Worker assignment
  workerId      String?
  workerAddress String?
  
  // Timing
  createdAt     DateTime  @default(now())
  queuedAt      DateTime?
  startedAt     DateTime?
  completedAt   DateTime?
  
  // Error handling
  error         String?
  retryCount    Int       @default(0)
  maxRetries    Int       @default(3)
  
  // References
  datasetId     String?
  trainedModelId String?

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  worker        Worker?        @relation(fields: [workerId], references: [id])
  dataset       Dataset?       @relation(fields: [datasetId], references: [id])
  trainedModel  TrainedModel?  @relation(fields: [trainedModelId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([workerId])
}

enum JobType {
  CRUCIBLE_TEXT
  CRUCIBLE_IMAGE
  CRUCIBLE_EMBEDDING
  CRUCIBLE_AUDIO
  CRUCIBLE_CODE
  CRUCIBLE_VISION
  FOUNDRY_FINETUNE
  FOUNDRY_TRAIN
  FOUNDRY_RLHF
}

enum JobStatus {
  PENDING
  QUEUED
  ASSIGNED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  TIMEOUT
}

// GPU Workers for Crucible & Foundry
model Worker {
  id            String       @id @default(cuid())
  walletAddress String       // Wallet address for payments
  hostname      String       // Machine hostname
  
  // Hardware specs
  gpuCount      Int          @default(0)
  gpuModels     String[]     // Array of GPU model names
  totalVram     Int          @default(0) // Total VRAM in GB
  cpuModel      String?
  cpuCores      Int?
  ramGb         Int?
  
  // Network info
  publicIp      String?
  p2pPort       Int          @default(30303)
  region        String?
  
  // Status
  status        WorkerStatus @default(OFFLINE)
  currentLoad   Int          @default(0) // Number of active jobs
  maxLoad       Int          @default(4) // Max concurrent jobs
  
  // Capabilities - what this worker can do
  capabilities  Json?        // { crucible: true, foundry: true, streamA: false, ... }
  
  // Stats
  totalJobs     Int          @default(0)
  successfulJobs Int         @default(0)
  failedJobs    Int          @default(0)
  totalEarnings Decimal      @default(0) @db.Decimal(18, 6)
  uptime        Float        @default(0) // Percentage
  avgJobTime    Int          @default(0) // Seconds
  
  // Timing
  createdAt     DateTime     @default(now())
  lastSeen      DateTime?    // Last heartbeat
  
  jobs          Job[]

  @@unique([walletAddress, hostname])
  @@index([status])
  @@index([walletAddress])
  @@index([region])
}

enum WorkerStatus {
  ONLINE
  BUSY
  OFFLINE
  MAINTENANCE
}

// Datasets for Foundry training
model Dataset {
  id            String        @id @default(cuid())
  userId        String
  name          String
  description   String?
  
  // Storage
  storageType   StorageType   @default(S3)
  storageUrl    String        // S3 URL or IPFS hash
  sizeBytes     BigInt
  rowCount      Int?
  
  // Format
  format        DatasetFormat
  schema        Json?         // Column definitions
  
  // Status
  status        DatasetStatus @default(UPLOADING)
  validatedAt   DateTime?
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobs          Job[]
  trainedModels TrainedModel[]

  @@index([userId])
}

enum StorageType {
  S3
  IPFS
  ARWEAVE
  URL
}

enum DatasetFormat {
  JSONL
  CSV
  PARQUET
  HF_DATASET
}

enum DatasetStatus {
  UPLOADING
  VALIDATING
  READY
  ERROR
}

// Trained Models from Foundry
model TrainedModel {
  id            String      @id @default(cuid())
  userId        String
  name          String
  description   String?
  
  // Base model info
  baseModel     String
  trainingType  String      // finetune, full, rlhf
  
  // Storage
  storageUrl    String      // Where model weights are stored
  sizeBytes     BigInt?
  
  // Training metadata
  datasetId     String?
  epochs        Int?
  batchSize     Int?
  learningRate  String?
  trainingTime  Int?        // Seconds
  trainingCost  Decimal?    @db.Decimal(18, 6)
  
  // Metrics
  metrics       Json?       // loss, accuracy, etc.
  
  // Status
  status        ModelStatus @default(TRAINING)
  
  // Publishing
  isPublic      Boolean     @default(false)
  downloads     Int         @default(0)
  
  createdAt     DateTime    @default(now())
  completedAt   DateTime?

  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  dataset       Dataset?    @relation(fields: [datasetId], references: [id])
  jobs          Job[]

  @@index([userId])
  @@index([status])
}

enum ModelStatus {
  TRAINING
  READY
  FAILED
  ARCHIVED
}

// Payments and Credits
model Payment {
  id            String        @id @default(cuid())
  userId        String
  type          PaymentType
  
  // Amount
  amount        Decimal       @db.Decimal(18, 6)
  currency      String        @default("PYRX")
  
  // Transaction
  txHash        String?
  blockNumber   Int?
  
  // Status
  status        PaymentStatus @default(PENDING)
  
  // Reference
  jobId         String?
  description   String?
  
  createdAt     DateTime      @default(now())
  confirmedAt   DateTime?

  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([txHash])
}

enum PaymentType {
  CREDIT_PURCHASE
  JOB_PAYMENT
  WORKER_PAYOUT
  REFUND
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  FAILED
  REFUNDED
}
