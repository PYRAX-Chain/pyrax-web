// Prisma schema for PYRAX Presale Admin Dashboard

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ Admin & Auth ============

model Admin {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  role          AdminRole @default(VIEWER)
  walletAddress String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLogin     DateTime?
  active        Boolean   @default(true)

  auditLogs AuditLog[]
  sessions  AdminSession[]
}

model AdminSession {
  id        String   @id @default(cuid())
  adminId   String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  ipAddress String?
  userAgent String?

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  VIEWER
}

// ============ Presale Phases ============

model PresalePhase {
  id            String   @id @default(cuid())
  phaseNumber   Int      @unique
  name          String
  description   String?
  priceUsd      Decimal  @db.Decimal(18, 6)
  pyrxBonusBps  Int      @default(0)
  xfBonusBps    Int      @default(0)
  capUsd        Decimal  @db.Decimal(18, 6)
  raisedUsd     Decimal  @default(0) @db.Decimal(18, 6)
  startTime     DateTime?
  endTime       DateTime?
  active        Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  contributions Contribution[]
}

// ============ Testnet Phases ============

model TestnetPhase {
  id          String   @id @default(cuid())
  phaseNumber Int      @unique
  name        String
  theme       String
  description String?
  objectives  String[]
  rewards     String?
  startTime   DateTime?
  endTime     DateTime?
  active      Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  participants TestnetParticipant[]
  progressTracking TestProgramProgress[]
}

model TestnetParticipant {
  id            String   @id @default(cuid())
  phaseId       String
  walletAddress String
  email         String?
  tasksCompleted Int     @default(0)
  rewardsEarned Decimal @default(0) @db.Decimal(18, 6)
  joinedAt      DateTime @default(now())

  phase TestnetPhase @relation(fields: [phaseId], references: [id])

  @@unique([phaseId, walletAddress])
}

// ============ Contributions ============

model Contribution {
  id              String   @id @default(cuid())
  phaseId         String
  walletAddress   String
  email           String?
  
  // Amounts contributed
  ethAmount       Decimal  @default(0) @db.Decimal(18, 8)
  usdcAmount      Decimal  @default(0) @db.Decimal(18, 6)
  usdtAmount      Decimal  @default(0) @db.Decimal(18, 6)
  wbtcAmount      Decimal  @default(0) @db.Decimal(18, 8)
  totalUsd        Decimal  @db.Decimal(18, 6)
  
  // Tokens to receive
  pyrxAmount      Decimal  @db.Decimal(18, 0)
  xfAmount        Decimal  @db.Decimal(18, 0)
  
  // Transaction details
  txHash          String?
  blockNumber     Int?
  status          ContributionStatus @default(PENDING)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  claimedAt       DateTime?

  phase PresalePhase @relation(fields: [phaseId], references: [id])

  @@index([walletAddress])
  @@index([txHash])
}

enum ContributionStatus {
  PENDING
  CONFIRMED
  FAILED
  CLAIMED
  REFUNDED
}

// ============ Treasury ============

model Treasury {
  id            String   @id @default(cuid())
  name          String
  address       String   @unique
  chain         String
  type          TreasuryType
  description   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  balances TreasuryBalance[]
  transactions TreasuryTransaction[]
}

model TreasuryBalance {
  id          String   @id @default(cuid())
  treasuryId  String
  token       String
  balance     Decimal  @db.Decimal(28, 18)
  usdValue    Decimal? @db.Decimal(18, 2)
  updatedAt   DateTime @updatedAt

  treasury Treasury @relation(fields: [treasuryId], references: [id])

  @@unique([treasuryId, token])
}

model TreasuryTransaction {
  id          String   @id @default(cuid())
  treasuryId  String
  type        TransactionType
  token       String
  amount      Decimal  @db.Decimal(28, 18)
  from        String?
  to          String?
  txHash      String?
  description String?
  createdAt   DateTime @default(now())

  treasury Treasury @relation(fields: [treasuryId], references: [id])

  @@index([txHash])
}

enum TreasuryType {
  PRESALE
  FOUNDATION
  ECOSYSTEM
  TEAM
  LIQUIDITY
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  TRANSFER
  SWAP
}

// ============ Analytics ============

model DailyStats {
  id              String   @id @default(cuid())
  date            DateTime @unique @db.Date
  
  // Presale stats
  contributionsCount Int    @default(0)
  uniqueContributors Int    @default(0)
  totalRaisedUsd    Decimal @default(0) @db.Decimal(18, 6)
  pyrxSold          Decimal @default(0) @db.Decimal(18, 0)
  xfDistributed     Decimal @default(0) @db.Decimal(18, 0)
  
  // By payment method
  ethRaised         Decimal @default(0) @db.Decimal(18, 8)
  usdcRaised        Decimal @default(0) @db.Decimal(18, 6)
  usdtRaised        Decimal @default(0) @db.Decimal(18, 6)
  wbtcRaised        Decimal @default(0) @db.Decimal(18, 8)
  
  createdAt         DateTime @default(now())
}

// ============ Audit Logs ============

model AuditLog {
  id          String   @id @default(cuid())
  adminId     String?
  action      String
  entity      String
  entityId    String?
  details     Json?
  ipAddress   String?
  createdAt   DateTime @default(now())

  admin Admin? @relation(fields: [adminId], references: [id])

  @@index([adminId])
  @@index([entity, entityId])
}

// ============ Settings ============

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  type      String   @default("string")
  updatedAt DateTime @updatedAt
}

// ============ Admin Whitelist ============

model AdminWhitelist {
  id                  String    @id @default(cuid())
  email               String    @unique
  passwordHash        String
  role                AdminRole @default(ADMIN)
  active              Boolean   @default(true)
  
  // Email confirmation
  emailConfirmed      Boolean   @default(false)
  confirmationToken   String?   @unique
  confirmationSentAt  DateTime?
  confirmedAt         DateTime?
  
  // Invitation tracking
  invitedBy           String?
  invitedAt           DateTime?
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  createdBy           String?
}

// ============ PYRAX Improvement Proposals (PIPs) ============

model Pip {
  id                String       @id @default(cuid())
  pipNumber         String       @unique // PIP-0001 format
  slug              String       @unique // URL-friendly slug
  
  // Content
  title             String
  summary           String       @db.Text
  motivation        String       @db.Text
  specification     String       @db.Text
  rationale         String?      @db.Text
  implementation    String?      @db.Text
  discussionLink    String?
  
  // Classification
  category          PipCategory  @default(PROTOCOL)
  
  // Author info
  authorWallet      String?
  authorName        String?
  authorEmail       String?
  
  // Voting configuration
  votingDurationDays Int         @default(7)
  quorumPercent     Int          @default(20)
  
  // Voting results
  forVotes          Decimal      @default(0) @db.Decimal(28, 0)
  againstVotes      Decimal      @default(0) @db.Decimal(28, 0)
  totalVoters       Int          @default(0)
  
  // Status
  status            PipStatus    @default(DRAFT)
  votingStartedAt   DateTime?
  votingEndsAt      DateTime?
  executedAt        DateTime?
  
  // Metrics
  viewCount         Int          @default(0)
  
  // Timestamps
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  
  // Relations
  votes             PipVote[]
  comments          PipComment[]
  
  @@index([status])
  @@index([category])
  @@index([pipNumber])
  @@index([createdAt])
}

model PipVote {
  id            String   @id @default(cuid())
  pipId         String
  
  // Voter info
  walletAddress String
  stakedAmount  Decimal  @db.Decimal(28, 0) // Voting power
  nodeRunning   Boolean  @default(false)    // Was node running at vote time
  
  // Vote
  voteType      VoteType // FOR or AGAINST
  
  createdAt     DateTime @default(now())
  
  pip           Pip      @relation(fields: [pipId], references: [id], onDelete: Cascade)
  
  @@unique([pipId, walletAddress])
  @@index([pipId])
  @@index([walletAddress])
}

model PipComment {
  id            String   @id @default(cuid())
  pipId         String
  parentId      String?  // For threaded replies
  
  // Author info
  authorType    String   // "wallet", "admin", "system"
  authorWallet  String?
  authorName    String?
  authorEmail   String?
  isOfficial    Boolean  @default(false) // Official PYRAX response
  
  // Source tracking
  source        String   @default("web") // "web", "desktop"
  
  // Content
  content       String   @db.Text
  
  // Moderation
  isHidden      Boolean  @default(false)
  isPinned      Boolean  @default(false)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  pip           Pip      @relation(fields: [pipId], references: [id], onDelete: Cascade)
  parent        PipComment? @relation("PipCommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies       PipComment[] @relation("PipCommentReplies")
  
  @@index([pipId])
  @@index([parentId])
  @@index([createdAt])
}

enum PipCategory {
  PROTOCOL        // Protocol upgrades
  TREASURY        // Treasury allocation
  PARAMETER       // Parameter changes
  ECOSYSTEM       // Ecosystem initiatives
  SECURITY        // Security enhancements
  DOCUMENTATION   // Documentation/process
}

enum PipStatus {
  DRAFT
  PENDING_REVIEW
  ACTIVE          // Voting in progress
  PASSED
  REJECTED
  IMPLEMENTED
  CANCELLED
}

// ============ PYRAX Forge Council (Public Issue Tracker) ============

model Issue {
  id            String       @id @default(cuid())
  issueNumber   String       @unique // IC-2501-XXXXXX format
  slug          String       @unique // URL-friendly slug
  
  // Source tracking
  source        String       // "forge-council", "network-hub", "explorer", "web"
  sourceVersion String?
  
  // Reporter info
  reporterId    String?      // User ID if logged in
  reporterEmail String?
  reporterName  String?
  reporterWallet String?
  
  // Issue content
  title         String
  summary       String       @db.Text
  description   String       @db.Text
  stepsToReproduce String?   @db.Text
  expectedBehavior String?   @db.Text
  actualBehavior String?     @db.Text
  logs          String?      @db.Text
  
  // Classification
  category      IssueCategory @default(BUG)
  severity      IssueSeverity @default(MODERATE)
  component     String?       // "Node A", "Node B", "Wallet", "Explorer", etc.
  environment   String?       // "DevNet", "Forge Testnet", "Production"
  version       String?
  
  // Status tracking
  status        IssueStatus  @default(NEW)
  priority      IssuePriority @default(MEDIUM)
  assignedTo    String?
  
  // Public metrics
  upvotes       Int          @default(0)
  downvotes     Int          @default(0)
  confirmations Int          @default(0)
  viewCount     Int          @default(0)
  
  // Visibility
  isPublic      Boolean      @default(true)
  isFeatured    Boolean      @default(false)
  isPinned      Boolean      @default(false)
  
  // Timestamps
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  resolvedAt    DateTime?
  
  // Duplicate/merge tracking
  mergedIntoId  String?        // If this issue was merged into another
  
  // Relations
  votes         IssueVote[]
  confirmers    IssueConfirmation[]
  comments      IssueComment[]
  attachments   IssueAttachment[]
  privateMessages PrivateIssueMessage[]
  merges        IssueMerge[]
  
  @@index([status])
  @@index([category])
  @@index([severity])
  @@index([issueNumber])
  @@index([createdAt])
  @@index([upvotes])
  @@index([confirmations])
}

model IssueVote {
  id        String   @id @default(cuid())
  issueId   String
  
  // Voter info (at least one required)
  userId    String?
  walletAddress String?
  ipHash    String?  // Hashed IP for anonymous votes
  
  voteType  VoteType // UP or DOWN
  createdAt DateTime @default(now())
  
  issue     Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  
  @@unique([issueId, walletAddress])
  @@unique([issueId, userId])
  @@index([issueId])
}

model IssueConfirmation {
  id            String   @id @default(cuid())
  issueId       String
  
  // Confirmer info
  userId        String?
  walletAddress String?
  displayName   String?
  
  // Confirmation details
  environment   String?  // What environment they confirmed on
  version       String?  // What version they confirmed on
  details       String?  @db.Text // Additional details
  
  createdAt     DateTime @default(now())
  
  issue         Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  
  @@unique([issueId, walletAddress])
  @@index([issueId])
}

model IssueComment {
  id          String   @id @default(cuid())
  issueId     String
  parentId    String?  // For threaded replies
  
  // Author info
  authorType  String   // "user", "admin", "reporter"
  authorId    String?
  authorWallet String?
  authorName  String?
  authorEmail String?
  isOfficial  Boolean  @default(false) // Official PYRAX response
  
  // Content
  content     String   @db.Text
  
  // Moderation
  isHidden    Boolean  @default(false)
  isPinned    Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  issue       Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  parent      IssueComment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     IssueComment[] @relation("CommentReplies")
  
  @@index([issueId])
  @@index([parentId])
  @@index([createdAt])
}

model IssueAttachment {
  id          String   @id @default(cuid())
  issueId     String
  
  fileName    String
  fileType    String
  fileSize    Int
  url         String
  
  createdAt   DateTime @default(now())
  
  issue       Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  
  @@index([issueId])
}

enum IssueCategory {
  BUG
  CRASH
  PERFORMANCE
  UI_UX
  FEATURE_REQUEST
  DOCUMENTATION
  SECURITY
  OTHER
}

enum IssueSeverity {
  BLOCKER      // Cannot use the system
  CRITICAL     // Major feature broken
  MAJOR        // Significant impact
  MODERATE     // Some impact
  MINOR        // Cosmetic or low impact
  TRIVIAL      // Very minor
}

enum IssueStatus {
  NEW
  CONFIRMED
  ACKNOWLEDGED
  INVESTIGATING
  IN_PROGRESS
  TESTING
  FIXED
  WONT_FIX
  DUPLICATE
  CANNOT_REPRODUCE
  CLOSED
}

enum IssuePriority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum VoteType {
  UP
  DOWN
}

// ============ Legacy Bug Reports (Desktop App Private Tickets) ============

model BugReport {
  id            String       @id @default(cuid())
  ticketNumber  String       @unique
  issueId       String?      // Link to public Issue if promoted
  source        String       // "network-hub", "explorer", "web"
  sourceVersion String?
  
  // Reporter info (optional)
  reporterEmail String?
  reporterName  String?
  
  // Report content
  title         String
  description   String       @db.Text
  logs          String?      @db.Text
  
  // Status tracking
  status        TicketStatus @default(OPEN)
  priority      TicketPriority @default(MEDIUM)
  assignedTo    String?
  
  // Timestamps
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  resolvedAt    DateTime?
  
  // Messages/responses
  messages      TicketMessage[]
  
  @@index([status])
  @@index([ticketNumber])
}

model TicketMessage {
  id          String   @id @default(cuid())
  ticketId    String
  sender      String   // "admin" or "user"
  senderName  String?
  message     String   @db.Text
  read        Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  ticket      BugReport @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  @@index([ticketId])
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_FOR_USER
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ============ CRUCIBLE & FOUNDRY - AI/ML Platform ============

// User account (wallet-based authentication)
model User {
  id            String    @id @default(cuid())
  walletAddress String    @unique
  email         String?
  name          String?
  credits       Decimal   @default(0) @db.Decimal(18, 6)
  tier          UserTier  @default(FREE)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastActiveAt  DateTime?

  apiKeys       ApiKey[]
  jobs          Job[]
  datasets      Dataset[]
  trainedModels TrainedModel[]
  payments      Payment[]

  @@index([walletAddress])
}

enum UserTier {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

// API Keys for programmatic access
model ApiKey {
  id          String    @id @default(cuid())
  userId      String
  name        String
  keyHash     String    @unique // Store hashed key, not plaintext
  keyPrefix   String    // First 8 chars for identification (pyrax_xxx...)
  permissions String[]  @default(["crucible:read", "crucible:write", "foundry:read", "foundry:write"])
  rateLimit   Int       @default(100) // requests per minute
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([keyHash])
  @@index([userId])
}

// Jobs - Crucible inference and Foundry training
model Job {
  id            String    @id @default(cuid())
  userId        String
  type          JobType
  status        JobStatus @default(PENDING)
  priority      Int       @default(0)
  
  // Model and input
  model         String
  input         Json      // Prompt, config, parameters
  output        Json?     // Results, generated content
  
  // Cost tracking
  estimatedCost Decimal   @default(0) @db.Decimal(18, 6)
  actualCost    Decimal   @default(0) @db.Decimal(18, 6)
  
  // Worker assignment
  workerId      String?
  workerAddress String?
  
  // Timing
  createdAt     DateTime  @default(now())
  queuedAt      DateTime?
  startedAt     DateTime?
  completedAt   DateTime?
  
  // Error handling
  error         String?
  retryCount    Int       @default(0)
  maxRetries    Int       @default(3)
  
  // References
  datasetId     String?
  trainedModelId String?

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  worker        Worker?        @relation(fields: [workerId], references: [id])
  dataset       Dataset?       @relation(fields: [datasetId], references: [id])
  trainedModel  TrainedModel?  @relation(fields: [trainedModelId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([workerId])
}

enum JobType {
  CRUCIBLE_TEXT
  CRUCIBLE_IMAGE
  CRUCIBLE_EMBEDDING
  CRUCIBLE_AUDIO
  CRUCIBLE_CODE
  CRUCIBLE_VISION
  FOUNDRY_FINETUNE
  FOUNDRY_TRAIN
  FOUNDRY_RLHF
}

enum JobStatus {
  PENDING
  QUEUED
  ASSIGNED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  TIMEOUT
}

// GPU Workers for Crucible & Foundry
model Worker {
  id            String       @id @default(cuid())
  walletAddress String       // Wallet address for payments
  hostname      String       // Machine hostname
  
  // Hardware specs
  gpuCount      Int          @default(0)
  gpuModels     String[]     // Array of GPU model names
  totalVram     Int          @default(0) // Total VRAM in GB
  cpuModel      String?
  cpuCores      Int?
  ramGb         Int?
  
  // Network info
  publicIp      String?
  p2pPort       Int          @default(30303)
  region        String?
  
  // Status
  status        WorkerStatus @default(OFFLINE)
  currentLoad   Int          @default(0) // Number of active jobs
  maxLoad       Int          @default(4) // Max concurrent jobs
  
  // Capabilities - what this worker can do
  capabilities  Json?        // { crucible: true, foundry: true, streamA: false, ... }
  
  // Stats
  totalJobs     Int          @default(0)
  successfulJobs Int         @default(0)
  failedJobs    Int          @default(0)
  totalEarnings Decimal      @default(0) @db.Decimal(18, 6)
  uptime        Float        @default(0) // Percentage
  avgJobTime    Int          @default(0) // Seconds
  
  // Timing
  createdAt     DateTime     @default(now())
  lastSeen      DateTime?    // Last heartbeat
  
  jobs          Job[]

  @@unique([walletAddress, hostname])
  @@index([status])
  @@index([walletAddress])
  @@index([region])
}

enum WorkerStatus {
  ONLINE
  BUSY
  OFFLINE
  MAINTENANCE
}

// Datasets for Foundry training
model Dataset {
  id            String        @id @default(cuid())
  userId        String
  name          String
  description   String?
  
  // Storage
  storageType   StorageType   @default(S3)
  storageUrl    String        // S3 URL or IPFS hash
  sizeBytes     BigInt
  rowCount      Int?
  
  // Format
  format        DatasetFormat
  schema        Json?         // Column definitions
  
  // Status
  status        DatasetStatus @default(UPLOADING)
  validatedAt   DateTime?
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobs          Job[]
  trainedModels TrainedModel[]

  @@index([userId])
}

enum StorageType {
  S3
  IPFS
  ARWEAVE
  URL
}

enum DatasetFormat {
  JSONL
  CSV
  PARQUET
  HF_DATASET
}

enum DatasetStatus {
  UPLOADING
  VALIDATING
  READY
  ERROR
}

// Trained Models from Foundry
model TrainedModel {
  id            String      @id @default(cuid())
  userId        String
  name          String
  description   String?
  
  // Base model info
  baseModel     String
  trainingType  String      // finetune, full, rlhf
  
  // Storage
  storageUrl    String      // Where model weights are stored
  sizeBytes     BigInt?
  
  // Training metadata
  datasetId     String?
  epochs        Int?
  batchSize     Int?
  learningRate  String?
  trainingTime  Int?        // Seconds
  trainingCost  Decimal?    @db.Decimal(18, 6)
  
  // Metrics
  metrics       Json?       // loss, accuracy, etc.
  
  // Status
  status        ModelStatus @default(TRAINING)
  
  // Publishing
  isPublic      Boolean     @default(false)
  downloads     Int         @default(0)
  
  createdAt     DateTime    @default(now())
  completedAt   DateTime?

  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  dataset       Dataset?    @relation(fields: [datasetId], references: [id])
  jobs          Job[]

  @@index([userId])
  @@index([status])
}

enum ModelStatus {
  TRAINING
  READY
  FAILED
  ARCHIVED
}

// Payments and Credits
model Payment {
  id            String        @id @default(cuid())
  userId        String
  type          PaymentType
  
  // Amount
  amount        Decimal       @db.Decimal(18, 6)
  currency      String        @default("PYRX")
  
  // Transaction
  txHash        String?
  blockNumber   Int?
  
  // Status
  status        PaymentStatus @default(PENDING)
  
  // Reference
  jobId         String?
  description   String?
  
  createdAt     DateTime      @default(now())
  confirmedAt   DateTime?

  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([txHash])
}

enum PaymentType {
  CREDIT_PURCHASE
  JOB_PAYMENT
  WORKER_PAYOUT
  REFUND
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  FAILED
  REFUNDED
}

// ============ Airdrop System for TGE ============

model AirdropRecipient {
  id                String           @id @default(cuid())
  walletAddress     String           @unique
  email             String?
  
  // Token allocations
  purchasedTokens   Decimal          @default(0) @db.Decimal(28, 0) // From presale
  testnetRewards    Decimal          @default(0) @db.Decimal(28, 0) // From testnet participation
  bugBountyRewards  Decimal          @default(0) @db.Decimal(28, 0) // From bug reporting
  referralRewards   Decimal          @default(0) @db.Decimal(28, 0) // From referrals
  bonusTokens       Decimal          @default(0) @db.Decimal(28, 0) // Any bonuses
  totalAllocation   Decimal          @default(0) @db.Decimal(28, 0) // Sum of all
  
  // XF Tokens (bonus token)
  xfAllocation      Decimal          @default(0) @db.Decimal(28, 0)
  
  // Claim status
  claimStatus       AirdropStatus    @default(PENDING)
  claimedAt         DateTime?
  claimTxHash       String?
  
  // Vesting (if applicable)
  vestingSchedule   String?          // e.g., "linear_12_months"
  vestedAmount      Decimal          @default(0) @db.Decimal(28, 0)
  
  // KYC (if required)
  kycStatus         KycStatus        @default(NOT_REQUIRED)
  kycCompletedAt    DateTime?
  
  // Tracking
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  // Relations
  rewardHistory     RewardHistory[]
  payoutRequests    PayoutRequest[]
  
  @@index([claimStatus])
  @@index([walletAddress])
}

model RewardHistory {
  id              String          @id @default(cuid())
  recipientId     String
  
  // Reward details
  rewardType      RewardType
  amount          Decimal         @db.Decimal(28, 0)
  tokenType       String          @default("PYRX") // PYRX or XF
  
  // Source reference
  sourceType      String          // "presale", "testnet", "bug_report", "referral", "bonus"
  sourceId        String?         // ID of the source (contribution ID, issue ID, etc.)
  description     String?
  
  // Phase tracking
  testPhaseId     String?
  presalePhaseId  String?
  
  // Status
  status          RewardStatus    @default(PENDING)
  approvedAt      DateTime?
  approvedBy      String?
  
  createdAt       DateTime        @default(now())
  
  recipient       AirdropRecipient @relation(fields: [recipientId], references: [id], onDelete: Cascade)
  
  @@index([recipientId])
  @@index([rewardType])
  @@index([status])
}

model PayoutRequest {
  id              String          @id @default(cuid())
  recipientId     String
  
  // Request details
  amount          Decimal         @db.Decimal(28, 0)
  tokenType       String          @default("PYRX")
  reason          String          // "test_phase_completion", "bug_bounty", etc.
  
  // Linked items
  testPhaseId     String?
  issueIds        String[]        // Array of issue IDs for bug bounties
  
  // Status
  status          PayoutStatus    @default(PENDING_REVIEW)
  reviewedBy      String?
  reviewedAt      DateTime?
  reviewNotes     String?
  
  // Payment (after TGE)
  paidAt          DateTime?
  txHash          String?
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  recipient       AirdropRecipient @relation(fields: [recipientId], references: [id], onDelete: Cascade)
  
  @@index([recipientId])
  @@index([status])
}

enum AirdropStatus {
  PENDING           // Waiting for TGE
  ELIGIBLE          // Ready to claim
  CLAIMING          // Claim in progress
  CLAIMED           // Successfully claimed
  VESTING           // In vesting period
  FORFEITED         // Lost eligibility
}

enum KycStatus {
  NOT_REQUIRED
  PENDING
  SUBMITTED
  APPROVED
  REJECTED
}

enum RewardType {
  PRESALE_PURCHASE
  TESTNET_PARTICIPATION
  BUG_REPORT_SUBMITTED
  BUG_CONFIRMED
  BUG_REPRODUCED
  BUG_FIXED_BOUNTY
  CRITICAL_BUG_BONUS
  REFERRAL
  EARLY_ADOPTER
  COMMUNITY_CONTRIBUTION
  BONUS
}

enum RewardStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

enum PayoutStatus {
  PENDING_REVIEW
  APPROVED
  REJECTED
  PROCESSING
  PAID
  CANCELLED
}

// ============ Test Program Progress Tracking ============

model TestProgramProgress {
  id                String          @id @default(cuid())
  walletAddress     String
  phaseId           String
  
  // Task completion tracking
  tasksCompleted    Json            // { "wallet_created": true, "first_tx": true, ... }
  totalTasks        Int             @default(0)
  completedTasks    Int             @default(0)
  
  // Bug reporting contributions
  bugsReported      Int             @default(0)
  bugsConfirmed     Int             @default(0)
  bugsReproduced    Int             @default(0)
  
  // Rewards for this phase
  earnedRewards     Decimal         @default(0) @db.Decimal(28, 0)
  bonusRewards      Decimal         @default(0) @db.Decimal(28, 0)
  
  // Phase completion
  isComplete        Boolean         @default(false)
  completedAt       DateTime?
  payoutRequested   Boolean         @default(false)
  payoutRequestId   String?
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  phase             TestnetPhase    @relation(fields: [phaseId], references: [id])
  
  @@unique([walletAddress, phaseId])
  @@index([walletAddress])
  @@index([phaseId])
}

// ============ Private Admin-Reporter Messaging ============

model PrivateIssueMessage {
  id              String          @id @default(cuid())
  issueId         String
  
  // Sender info
  senderType      String          // "admin" or "reporter"
  senderWallet    String?
  senderName      String?
  senderEmail     String?
  adminId         String?
  
  // Content
  content         String          @db.Text
  
  // Attachments (log files, screenshots)
  attachments     Json?           // Array of { name, url, type }
  
  // Read status
  readByAdmin     Boolean         @default(false)
  readByReporter  Boolean         @default(false)
  
  createdAt       DateTime        @default(now())
  
  issue           Issue           @relation(fields: [issueId], references: [id], onDelete: Cascade)
  
  @@index([issueId])
  @@index([createdAt])
}

// ============ Issue Merging/Duplicates ============

model IssueMerge {
  id              String          @id @default(cuid())
  
  // The primary issue that others are merged into
  primaryIssueId  String
  
  // The duplicate issues being merged
  mergedIssueIds  String[]
  
  // Admin who performed the merge
  mergedBy        String
  mergedByName    String?
  
  // Reason for merge
  reason          String?
  
  createdAt       DateTime        @default(now())
  
  primaryIssue    Issue           @relation(fields: [primaryIssueId], references: [id], onDelete: Cascade)
  
  @@index([primaryIssueId])
}

// ============ System Status Monitoring ============

model StatusService {
  id              String          @id @default(cuid())
  name            String          // "Node A", "Node B", "Web App", "Explorer", etc.
  slug            String          @unique // URL-friendly identifier
  description     String?
  
  // Service details
  category        ServiceCategory @default(CORE)
  url             String?         // Health check URL
  checkInterval   Int             @default(60) // Seconds between checks
  timeout         Int             @default(30) // Request timeout in seconds
  
  // Current status
  status          ServiceStatus   @default(OPERATIONAL)
  lastCheckedAt   DateTime?
  lastStatusChange DateTime?
  responseTime    Int?            // Last response time in ms
  
  // Uptime tracking
  uptimePercent   Float           @default(100)
  uptimeDay       Float           @default(100)
  uptimeWeek      Float           @default(100)
  uptimeMonth     Float           @default(100)
  
  // Display order
  displayOrder    Int             @default(0)
  isPublic        Boolean         @default(true)
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  // Relations
  checks          StatusCheck[]
  incidents       StatusIncident[]
  
  @@index([status])
  @@index([category])
}

model StatusCheck {
  id              String          @id @default(cuid())
  serviceId       String
  
  // Check result
  status          ServiceStatus
  responseTime    Int?            // Response time in ms
  statusCode      Int?            // HTTP status code
  error           String?         // Error message if any
  
  // Metadata
  checkedFrom     String?         // Region/server that performed check
  
  createdAt       DateTime        @default(now())
  
  service         StatusService   @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  @@index([serviceId])
  @@index([createdAt])
  @@index([serviceId, createdAt])
}

model StatusIncident {
  id              String          @id @default(cuid())
  serviceId       String?         // Null for system-wide incidents
  
  // Incident details
  title           String
  description     String          @db.Text
  severity        IncidentSeverity @default(MINOR)
  status          IncidentStatus  @default(INVESTIGATING)
  
  // Impact tracking
  impactStart     DateTime        @default(now())
  impactEnd       DateTime?
  
  // Resolution
  resolvedAt      DateTime?
  postmortem      String?         @db.Text
  
  // Timestamps
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  // Relations
  service         StatusService?  @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  updates         IncidentUpdate[]
  
  @@index([serviceId])
  @@index([status])
  @@index([impactStart])
}

model IncidentUpdate {
  id              String          @id @default(cuid())
  incidentId      String
  
  // Update content
  status          IncidentStatus
  message         String          @db.Text
  
  // Author
  authorName      String?
  authorEmail     String?
  
  createdAt       DateTime        @default(now())
  
  incident        StatusIncident  @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  
  @@index([incidentId])
  @@index([createdAt])
}

model StatusSubscriber {
  id              String          @id @default(cuid())
  email           String          @unique
  
  // Subscription preferences
  notifyAll       Boolean         @default(true) // All incidents
  notifyMajor     Boolean         @default(true) // Major/Critical only
  notifyServices  String[]        // Specific service IDs (empty = all)
  
  // Verification
  verified        Boolean         @default(false)
  verifyToken     String?         @unique
  verifiedAt      DateTime?
  
  // Unsubscribe
  unsubscribeToken String         @unique @default(cuid())
  unsubscribedAt  DateTime?
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([verified])
}

model StatusMetric {
  id              String          @id @default(cuid())
  serviceId       String
  
  // Time bucket (hourly aggregation)
  hour            DateTime        @db.Timestamp
  
  // Metrics
  checksTotal     Int             @default(0)
  checksSuccess   Int             @default(0)
  checksFailed    Int             @default(0)
  avgResponseTime Int?
  minResponseTime Int?
  maxResponseTime Int?
  uptimePercent   Float           @default(100)
  
  @@unique([serviceId, hour])
  @@index([serviceId])
  @@index([hour])
}

enum ServiceCategory {
  CORE            // Core blockchain services
  INFRASTRUCTURE  // Infrastructure services
  API             // API services
  WEB             // Web applications
  TOOLS           // Developer tools
}

enum ServiceStatus {
  OPERATIONAL     // All systems go
  DEGRADED        // Slow or partial outage
  PARTIAL_OUTAGE  // Some functionality unavailable
  MAJOR_OUTAGE    // Service down
  MAINTENANCE     // Planned maintenance
  UNKNOWN         // Status unknown
}

enum IncidentSeverity {
  MINOR           // Minimal impact
  MAJOR           // Significant impact
  CRITICAL        // Service unavailable
}

enum IncidentStatus {
  INVESTIGATING   // Looking into the issue
  IDENTIFIED      // Root cause identified
  MONITORING      // Fix deployed, monitoring
  RESOLVED        // Incident resolved
  SCHEDULED       // Scheduled maintenance
}

// ============ TGE Airdrop Rewards (Test Program) ============

model TesterReward {
  id                String          @id @default(cuid())
  walletAddress     String
  
  // Reward source
  source            RewardSource
  sourceId          String?         // Reference to phase, bug report, etc.
  description       String
  
  // Reward amount (in PYRAX tokens)
  amount            Decimal         @db.Decimal(28, 0)
  
  // Status
  status            RewardStatus    @default(PENDING)
  
  // TGE distribution
  claimableAt       DateTime?       // When rewards become claimable (TGE)
  claimedAt         DateTime?
  claimTxHash       String?
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@index([walletAddress])
  @@index([status])
  @@index([source])
}

model Tester {
  id                String          @id @default(cuid())
  walletAddress     String          @unique
  email             String?
  discordUsername   String?
  
  // Registration
  registeredAt      DateTime        @default(now())
  referredBy        String?         // Referral wallet
  
  // Overall progress
  currentPhase      String          @default("forge")
  totalRewards      Decimal         @default(0) @db.Decimal(28, 0)
  completedPhases   Int             @default(0)
  
  // Activity tracking
  totalTransactions Int             @default(0)
  totalBugsReported Int             @default(0)
  nodesRun          Int             @default(0)
  blocksMinedTotal  Int             @default(0)
  
  // Timestamps
  lastActiveAt      DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@index([registeredAt])
  @@index([totalRewards])
}

enum RewardSource {
  PHASE_COMPLETION  // Completed a test phase
  OBJECTIVE         // Completed an objective
  BUG_REPORT        // Reported a valid bug
  BUG_BOUNTY        // Critical bug bounty
  REFERRAL          // Referred another tester
  BONUS             // Special bonus reward
  EARLY_TESTER      // Early tester bonus
}

// ============ Blog System ============

model BlogPost {
  id          String      @id @default(cuid())
  slug        String      @unique
  title       String
  excerpt     String
  content     String      @db.Text
  coverImage  String?
  author      String      @default("PYRAX Team")
  category    String      @default("announcements")
  tags        String[]
  featured    Boolean     @default(false)
  status      PostStatus  @default(DRAFT)
  readTime    Int         @default(5)
  publishedAt DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  @@index([status])
  @@index([category])
  @@index([publishedAt])
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model CommunityLink {
  id            String          @id @default(cuid())
  title         String
  url           String          @unique
  description   String
  authorName    String
  authorTwitter String?
  thumbnailUrl  String?
  category      String          @default("other")
  status        LinkStatus      @default(PENDING)
  submittedAt   DateTime        @default(now())
  approvedAt    DateTime?
  reviewedBy    String?
  
  @@index([status])
  @@index([category])
}

enum LinkStatus {
  PENDING
  APPROVED
  REJECTED
}
